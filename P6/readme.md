# 设计文档
mult, multu, div, divu, mfhi, mflo, mthi, mtlo

优化：删除了reg_data_W reg_data_op_W直接用give_W作为GRF写数据

# MD
start busy
md_op
hi lo
cnt md_op_reg rs_reg rt_reg
注意符号处理！
verilog 默认无符号乘法 RTL默认有符号乘法

## CU_M
dm写控制
input mem_addr fwd_rt_data
output dm_op m_data_byteen m_data_wdata

可优化剥离出新模块控制dm读入数据

## BE
DM读数据修正
lb lh符号扩展

# 测试方案

    抽象分组 cal_r cal_i load store md,先测试cal_r cal_i正确性，再测试load store与cal的冲突，再jal以及bne beq。并利用讨论区工具。

# 思考题

1. 为什么需要有单独的乘除法部件而不是整合进 ALU？为何需要有独立的 HI、LO 寄存器？
   
   乘除法计算过慢，应当分为多周期完成。
   乘法计算与ALU是并行的，需要单独保存计算结果。

2. 真实的流水线 CPU 是如何使用实现乘除法的？请查阅相关资料进行简单说明。
   
    大多数CPU采用查找表完成乘法计算，例如记录4位二进制数乘法的256个结果，在计算8位二进制数时，将8位数拆分成2个二进制数，再移位相加4个结果。现代CPU很少使用传统的移位加法算法在微代码中完成，但那会非常慢。
    一个n位除法器需要占用大量空间的n*n 个元素。因此，大多数小型 CPU 使用传统的移位和减法算法在微代码中实现它，或者（更典型地）完全忽略它。只有当你达到百万晶体管规模的 CPU 时，逻辑方法才变得经济。
    from quora

3. 请结合自己的实现分析，你是如何处理 Busy 信号带来的周期阻塞的？
   
    在MD模块中，我设置了6个寄存器，md_op_reg rs_reg rt_reg cnt hi lo,我在乘除法计算的5/10个周期的末尾进行计算赋值(模拟“计算时间”选择记录md_op rs rt)。

4. 请问采用字节使能信号的方式处理写指令有什么好处？（提示：从清晰性、统一性等角度考虑）

    各个写内存指令只需在CU_M中修改字节使能并对字移位即可。

5. 请思考，我们在按字节读和按字节写时，实际从 DM 获得的数据和向DM 写入的数据是否是一字节？在什么情况下我们按字节读和按字节写的效率会高于按字读和按字写呢？
   
    是一个完整的字。当我们只需要读写特定字节而非整个字时，可避免对读写的字进行移位操作。

6. 为了对抗复杂性你采取了哪些抽象和规范手段？这些手段在译码和处理数据冲突的时候有什么样的特点与帮助？

    指令分组为 cal_r cal_i load store md(mult multu div divu)
    相似指令无需修改CU，只需添加到相应组，便于添加指令，减少bug。

7. 在本实验中你遇到了哪些不同指令类型组合产生的冲突？你又是如何解决的？相应的测试样例是什么样的？
   
    乘除法类型指令的冲突。

    ```verilog
    stall      = (stall_rs_E | stall_rs_M) | (stall_rt_E | stall_rt_M) | ((busy | start) & (md | mfhi | mflo | mthi | mtlo));
    ```

    ```mips
    ori $2, $0, 3
    ori $3, $0, 5
    mult $2, $3
    mflo $4
    mflo $5
    addi $4, $4, 100 
    ```

8. 如果你是手动构造的样例，请说明构造策略，说明你的测试程序如何保证覆盖了所有需要测试的情况；如果你是完全随机生成的测试样例，请思考完全随机的测试程序有何不足之处；如果你在生成测试样例时采用了特殊的策略，比如构造连续数据冒险序列，请你描述一下你使用的策略如何结合了随机性达到强测的效果。

    抽象分组 cal_r cal_i load store md,先测试cal_r cal_i正确性，再测试load store与cal的冲突，再jal以及bne beq。实际上，个人手动构造样例极难覆盖全部内容，工作量过大。我在测试时漏了

    ```mips
    jal lable
    lable: lw $2, -0x3000($31)
    nop
    ```

9.  [P5、P6 选做] 请评估我们给出的覆盖率分析模型的合理性，如有更好的方案，可一并提出。